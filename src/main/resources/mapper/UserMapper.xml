<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.cupk.trafficviolationidentificationsystem.repository.UserMapper">

 <resultMap id="UserResultMap" type="edu.cupk.trafficviolationidentificationsystem.model.User">
  <id property="userId" column="user_id"/>
  <result property="username" column="username"/>
  <result property="passwordHash" column="password_hash"/>
  <result property="fullName" column="full_name"/>
  <result property="email" column="email"/>
  <result property="phoneNumber" column="phone_number"/>
  <result property="avatarUrl" column="avatar_url"/>
  <result property="rank" column="rank"/>
  <result property="registrationStatus" column="registration_status"/>
  <result property="verificationToken" column="verification_token"/>
  <result property="verificationTokenExpiresAt" column="verification_token_expires_at"/>
  <result property="lastLoginAt" column="last_login_at"/>
  <result property="createdAt" column="created_at"/>
  <result property="updatedAt" column="updated_at"/>
 </resultMap>

 <select id="findByUsername" resultMap="UserResultMap">
  SELECT * FROM users WHERE username = #{username}
 </select>

 <select id="findByEmail" resultMap="UserResultMap">
  SELECT * FROM users WHERE email = #{email}
 </select>

 <select id="existsByUsername" resultType="boolean">
  SELECT COUNT(1) FROM users WHERE username = #{username}
 </select>

 <select id="existsByEmail" resultType="boolean">
  SELECT COUNT(1) FROM users WHERE email = #{email}
 </select>

 <insert id="save" useGeneratedKeys="true" keyProperty="userId">
  INSERT INTO users (username, password_hash, full_name, email, `rank`, registration_status)
  VALUES (#{username}, #{passwordHash}, #{fullName}, #{email}, #{rank}, #{registrationStatus})
 </insert>

 <update id="updateUserStatus">
  UPDATE users SET registration_status = #{status} WHERE user_id = #{userId}
 </update>

 <update id="updateUserPassword">
  UPDATE users SET password_hash = #{passwordHash} WHERE user_id = #{userId}
 </update>

 <select id="findAll" resultMap="UserResultMap">
  SELECT * FROM users ORDER BY created_at DESC
 </select>

</mapper>